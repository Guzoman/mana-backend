# --- util: websockets
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# --- redirect HTTP a HTTPS para ambos
server {
    listen 80;
    server_name api.manaproject.app flowise.manaproject.app;
    location ^~ /.well-known/acme-challenge/ { root /var/www/acme; default_type text/plain; }
    return 301 https://$host$request_uri;
}

# --- upstreams
upstream auth_bff   { server auth-bff:3000;   keepalive 32; }
upstream flowise_ui { server flowise:3001;    keepalive 16; }

# --- API
server {
    listen 443 ssl http2;
    server_name api.manaproject.app;

    ssl_certificate     /etc/nginx/ssl/origin-fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:MANA:10m;
    ssl_protocols TLSv1.2 TLSv1.3;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    location = /health { add_header Content-Type text/plain always; return 200 ok; }

    # CORS: autoriza tu front en vercel
    set $cors_origin "";
    if ($http_origin = "https://www.manaproject.app") { set $cors_origin $http_origin; }
    if ($http_origin = "https://manaproject.app")      { set $cors_origin $http_origin; }

    # Preflight
    location ~* ^/(api|flowise-api)(/|$) {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With" always;
            add_header Vary "Origin" always;
            return 204;
        }

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS en respuestas reales
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Vary "Origin" always;

        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_pass http://auth_bff;
    }
}

# --- FLOWISE UI (dominio raíz)
server {
    listen 443 ssl http2;
    server_name flowise.manaproject.app;

    ssl_certificate     /etc/nginx/ssl/origin-fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/origin-privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:MANA:10m;
    ssl_protocols TLSv1.2 TLSv1.3;

    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    location = /health { add_header Content-Type text/plain always; return 200 ok; }

    # Flowise UI en raíz (sin subpath)
    location / {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_pass http://flowise_ui;
    }
}